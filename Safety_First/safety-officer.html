<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safety Officer Dashboard - Safety Reporting System</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .report-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .btn-status {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .btn-status.pending {
            background-color: #ff9800;
            color: white;
        }
        .btn-status.in-progress {
            background-color: #2196f3;
            color: white;
        }
        .btn-status.resolved {
            background-color: #4caf50;
            color: white;
        }
        .btn-status.rejected {
            background-color: #f44336;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-user-shield"></i> Safety Officer Dashboard</h1>
            <p>Manage and investigate safety reports</p>
            <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>

        <div class="main-content">
            <div class="user-info">
                <strong><i class="fas fa-user"></i> Welcome, <span id="userName"></span></strong>
                <div style="font-size: 14px; margin-top: 5px;">
                    <i class="fas fa-user-tag"></i> Role: <span id="userRole"></span> | 
                    <i class="fas fa-building"></i> Department: <span id="userDepartment"></span>
                </div>
            </div>

            <div id="alertContainerMain"></div>

            <div class="reports-section">
                <h3><i class="fas fa-clipboard-list"></i> All Safety Reports</h3>
                <div class="report-filters">
                    <select id="statusFilter">
                        <option value="all">All Statuses</option>
                        <option value="pending">Pending</option>
                        <option value="in-progress">In Progress</option>
                        <option value="resolved">Resolved</option>
                        <option value="rejected">Rejected</option>
                    </select>
                    <button onclick="filterReports()">Filter</button>
                </div>
                <div id="allReportsContainer">
                    <p style="text-align: center; color: #666;">Loading reports...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        async function displayAllReports(filterStatus = 'all') {
            try {
                const container = document.getElementById('allReportsContainer');
                container.innerHTML = '<p style="text-align: center; color: #666;">Loading reports...</p>';
                
                let reports = await getAllReports();
                
                if (filterStatus !== 'all') {
                    reports = reports.filter(r => r.status === filterStatus);
                }
                
                if (reports.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666;">No reports found</p>';
                    return;
                }
                
                container.innerHTML = reports.map(report => `
                    <div class="report-item">
                        <div class="report-header">
                            <h4>${report.hazardType.replace('-', ' ').toUpperCase()}</h4>
                            <span class="severity-badge badge-${report.severity}">${report.severity.toUpperCase()}</span>
                            <span class="status-badge" style="background-color: ${getStatusColor(report.status)}">
                                ${report.status.toUpperCase()}
                            </span>
                        </div>
                        <p><strong>Location:</strong> ${report.location}</p>
                        <p><strong>Description:</strong> ${report.description}</p>
                        <p><strong>Reported by:</strong> ${report.userName} (${report.user})</p>
                        <p><strong>Date:</strong> ${new Date(report.date).toLocaleString()}</p>
                        ${report.photo ? `<div class="photo-preview"><img src="${report.photo}" alt="Report photo"></div>` : ''}
                        
                        <div class="report-actions">
                            <button class="btn-status pending" onclick="updateReportStatus(${report.id}, 'pending')">
                                <i class="fas fa-clock"></i> Pending
                            </button>
                            <button class="btn-status in-progress" onclick="updateReportStatus(${report.id}, 'in-progress')">
                                <i class="fas fa-spinner"></i> In Progress
                            </button>
                            <button class="btn-status resolved" onclick="updateReportStatus(${report.id}, 'resolved')">
                                <i class="fas fa-check"></i> Resolved
                            </button>
                            <button class="btn-status rejected" onclick="updateReportStatus(${report.id}, 'rejected')">
                                <i class="fas fa-times"></i> Reject
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading reports:', error);
                const container = document.getElementById('allReportsContainer');
                container.innerHTML = '<p style="text-align: center; color: #666;">Error loading reports</p>';
            }
        }
        
        function getStatusColor(status) {
            switch(status) {
                case 'pending': return '#ff9800';
                case 'in-progress': return '#2196f3';
                case 'resolved': return '#4caf50';
                case 'rejected': return '#f44336';
                default: return '#9e9e9e';
            }
        }
        
        async function updateReportStatus(reportId, newStatus) {
            try {
                await updateReportStatus(reportId, newStatus);
                showAlert(`Report status updated to ${newStatus}`, 'success', 'alertContainerMain');
                await displayAllReports(document.getElementById('statusFilter').value);
            } catch (error) {
                console.error('Error updating report:', error);
                showAlert('Failed to update report status', 'error', 'alertContainerMain');
            }
        }
        
        function filterReports() {
            const status = document.getElementById('statusFilter').value;
            displayAllReports(status);
        }
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', async function() {
            // User info is handled by the main script.js initialization
            await displayAllReports();
        });
    </script>
</body>
</html>